---
title: "Time Series Homework: Chapter 5 Lesson 4"
subtitle: "Please_put_your_name_here"
format: 
  html:
    embed-resources: true
    toc: true
---

```{r, echo=FALSE, message=FALSE, warning=FALSE}

# Loading R packages

if (!require("pacman")) install.packages("pacman")
pacman::p_load(nlme, tsibble, fable,feasts, tsibbledata,
               fable.prophet, patchwork,lubridate, 
               rio,ggplot2,kableExtra,tidyquant, 
               dplyr , plotly,tidymodels, 
               multilevelmod, broom.mixed
)
```

## Data

```{r, message=FALSE}

food_bev_ts <- rio::import("https://byuistats.github.io/timeseries/data/retail_by_business_type.parquet") |>
  filter(naics == 445) |>
  as_tsibble(index = month)

dep_stores_ts <- rio::import("https://byuistats.github.io/timeseries/data/retail_by_business_type.parquet") |>
  filter(naics == 4521) |>
  as_tsibble(index = month)

```

## Questions

### Question 1 - Model Selection (55 points)

##### a) Plot the Department Stores (NAICS: 445) series.

::: {.callout-note title="Answer" icon="false"}
```{r}

ggplot(dep_stores_ts, aes(x = month, y = sales_millions))+
  geom_line()+
  theme_bw()+
  labs(y = "Sales USD (Millions)",
       x = "Obsereved Time")


```
:::

##### b) Using the plot, speculate, which model is likely to be a good fit for the time series? Please specify the trend, seasonality, and random component modeling choices.

::: {.callout-note title="Answer" icon="false"}
Looking at the plot, the trend shows a a cubic looking pattern justifying the use of a cubic model. To capture the repeating seasonal patterns, harmonic seasonal terms would be appropriate, as they can smoothly model cyclical behavior. Once the trend and seasonality are accounted for, examining the residuals using an autocorrelogram can help identify remaining structure. If there is still significant autocorrelation, particularly at short lags, it would be appropriate to include an autoregressive (AR) component to capture that dependency.
:::

##### c) Please estimate three alternative models you think could be reasonable candidates for the data generating process for the Department Stores time series. Provide a table comparing the models the AIC, AICc, and BIC.

::: {.callout-note title="Answer" icon="false"}
```{r}
dep_harmonics <- dep_stores_ts |>
  mutate(TIME = 1:n()) |>
  mutate(
    cos1 = cos(2 * pi * 1 * TIME/12),
    cos2 = cos(2 * pi * 2 * TIME/12),
    cos3 = cos(2 * pi * 3 * TIME/12),
    cos4 = cos(2 * pi * 4 * TIME/12),
    cos5 = cos(2 * pi * 5 * TIME/12),
    cos6 = cos(2 * pi * 6 * TIME/12),
    sin1 = sin(2 * pi * 1 * TIME/12),
    sin2 = sin(2 * pi * 2 * TIME/12),
    sin3 = sin(2 * pi * 3 * TIME/12),
    sin4 = sin(2 * pi * 4 * TIME/12),
    sin5 = sin(2 * pi * 5 * TIME/12),
    sin6 = sin(2 * pi * 6 * TIME/12)) |>
  as_tsibble(index = TIME) |>
  mutate(zTIME = (TIME - mean(TIME)) / sd(TIME))


full_cubic_lm <- dep_harmonics |>
  model(full_cubic = TSLM(sales_millions ~ zTIME + I(zTIME^2) + I(zTIME^3) +
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 
    + sin4 + cos4 + sin5 + cos5 + cos6 )) 
full_cubic_lm |>
  tidy() |>
  mutate(sig = p.value < 0.05)

full_polynomial_lm <- dep_harmonics |>
  model(full_polynomial_lm = TSLM(sales_millions ~ zTIME + I(zTIME^2) + I(zTIME^3) + I(zTIME^4)+
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 
    + sin4 + cos4 + sin5 + cos5 + cos6 )) 
full_polynomial_lm |>
  tidy() |>
  mutate(sig = p.value < 0.05)

full_quadratic_lm <- dep_harmonics |>
  model(full_quadratic = TSLM(sales_millions ~ zTIME + I(zTIME^2)  +
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 
    + sin4 + cos4 + sin5 + cos5 + cos6 )) 
full_quadratic_lm |>
  tidy() |>
  mutate(sig = p.value < 0.05)

model_combined <- dep_harmonics |>
  model(
    full_cubic = TSLM(sales_millions ~ zTIME + I(zTIME^2) + I(zTIME^3) +
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 
    + sin4 + cos4 + sin5 + cos5 + cos6 ),
    full_polynomial = TSLM(sales_millions ~ zTIME + I(zTIME^2) + I(zTIME^3) + I(zTIME^4)+
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 
    + sin4 + cos4 + sin5 + cos5 + cos6),
    full_quadratic = TSLM(sales_millions ~ zTIME + I(zTIME^2)  +
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 
    + sin4 + cos4 + sin5 + cos5 + cos6 )
  )

glance(model_combined) |>
  select(.model, AIC, AICc, BIC)

```
:::

##### d) Justify your preferred model, make sure you take into account both the model selection criteria and the discussion on the dangers of only using algorithms for model selection found on the Time Series notebook (5.3).

::: {.callout-note title="Answer" icon="false"}
Out of the three models, the full_cubic and full_polynomial have the lowest AIC, AICc, and BIC, suggesting they offers the best balance of fit and complexity based on these criteria. However, model selection should not rely solely on algorithms, interpretability and the purpose of the analysis matter as well. In general when the model selection criteria is simillar, it is appropriate to choose the simpler model. For that reason the full_quadratic model is the best selection.
:::


### Question 2 - Logarithmic Transformation Estimation and Bias Correction (60 points)

You used the Food and Beverage Retail Sales series (NAICS: 4521) in the previous homework assignment. You estimated it with non-linear exponential model.

a)  Please estimate the Food and Beverage Retail Sales series using the logarithmic transformation of the series. Report the results in a professionally formatted table.

::: {.callout-note title="Answer" icon="false"}
```{r}

food_harmonics <- food_bev_ts  |>
  mutate(TIME = 1:n()) |>
  as_tsibble(index = TIME) |>
  mutate(zTIME = (TIME - mean(TIME)) / sd(TIME))|>
  mutate(
    cos1 = cos(2 * pi * 1 * TIME/12),
    cos2 = cos(2 * pi * 2 * TIME/12),
    cos3 = cos(2 * pi * 3 * TIME/12),
    cos4 = cos(2 * pi * 4 * TIME/12),
    cos5 = cos(2 * pi * 5 * TIME/12),
    cos6 = cos(2 * pi * 6 * TIME/12),
    sin1 = sin(2 * pi * 1 * TIME/12),
    sin2 = sin(2 * pi * 2 * TIME/12),
    sin3 = sin(2 * pi * 3 * TIME/12),
    sin4 = sin(2 * pi * 4 * TIME/12),
    sin5 = sin(2 * pi * 5 * TIME/12),
    sin6 = sin(2 * pi * 6 * TIME/12)) 


full_cubic_lm <- food_harmonics |>
  model(full_cubic = TSLM(log(sales_millions) ~ zTIME + I(zTIME^2) + I(zTIME^3) +
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 
    + sin4 + cos4 + sin5 + cos5 + cos6 )) 
full_cubic_lm |>
  tidy() |>
  mutate(sig = p.value < 0.05)

model_combined <- food_harmonics |>
  model(
    full_cubic = TSLM(log(sales_millions) ~ zTIME + I(zTIME^2) + I(zTIME^3) +
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 
    + sin4 + cos4 + sin5 + cos5 + cos6 ),
    full_linear = TSLM(log(sales_millions) ~ zTIME  +
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 
    + sin4 + cos4 + sin5 + cos5 + cos6 ),
    full_quadratic = TSLM(log(sales_millions) ~ zTIME + I(zTIME^2)  +
    sin1 + cos1 + sin2 + cos2 + sin3 + cos3 
    + sin4 + cos4 + sin5 + cos5 + cos6 ))


glance(model_combined) |>
  select(.model, AIC, AICc, BIC)

```
:::

b)  Please justify your model specification.

::: {.callout-note title="Answer" icon="false"}
We chose the cubic model specification after fitting several polynomial models to the log-transformed sales data. The use of a log transformation was motivated by the observed exponential growth pattern in the data, which suggests that a model capturing proportional rather than additive changes over time would be more appropriate. When we fit the cubic model, we found that all terms were statistically significant. As well the cubic model had the lowest AIC, AICc and BIC showing the model fit the data best.
:::

c)  Please interpret the estimates for the coefficients of the logarithmic transformation model. Pretend you are presenting the results to an executive who took a linear regression course in undergraduate but is not an expert.

::: {.callout-note title="Answer" icon="false"}
The model we fitted predicts the logarithm of sales based on both long-term trends and seasonal patterns. The intercept represents the baseline level of log-sales around the center of the time period. The negative coefficients for the linear and quadratic time terms indicate an initial decline in growth, while the positive cubic term suggests that sales begin to recover or accelerate again later capturing a curved, non-linear trend over time. The sinusoidal (sine and cosine) terms capture recurring seasonal effects at multiple frequencies. All of these terms are statistically significant, meaning both the long-term trend and seasonality are strongly supported by the data. Together, the model reflects a realistic pattern of declining growth followed by recovery, overlaid with regular seasonal fluctuations in sales.
:::

d)  Please evaluate the estimation residuals and use the appropriate bias correction procedure for log-transform estimates. Please justify your choice.

::: {.callout-note title="Answer" icon="false"}
```{r}

food_resid_df <- model_combined |> 
  dplyr::select(full_cubic) |>
  residuals() |> 
  as_tibble() |> 
  dplyr::select(.resid) |>
  rename(x = .resid) 


skewness(food_resid_df$x)


food_resid_df |>
  mutate(density = dnorm(x, mean(food_resid_df$x), sd(food_resid_df$x))) |>
  ggplot(aes(x = x)) +
    geom_histogram(aes(y = after_stat(density)),
        color = "white", fill = "#56B4E9", binwidth = 0.01) +
    geom_line(aes(x = x, y = density)) +
    theme_bw() +
    labs(
      x = "Values",
      y = "Frequency",
      title = ""
    ) +
    theme(
      plot.title = element_text(hjust = 0.5)
    )
```

The skewness of the residuals is at 0.682, meaning there is moderate positive skewness in the residuals. Due to this we can apply log normal correction as bias correction. We do this instead of empirical correction as the residuals are positively skewed. 
:::



### Rubric

+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Criteria**                                              | **Mastery (10)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | **Incomplete (0)**                                                                                                                                                                                                                                                                                                                        |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| #### **Question 1: Definitions**                          | The student provides sufficient evidence of mastery of the outcome prompt. The submission included mathematical expressions or illustration if available in the text or the Time Series Notebook                                                                                                                                                                                                                                                                                                                  | The student did not provide sufficient evidence to evaluate the outcome prompt.                                                                                                                                                                                                                                                           |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                           | **Mastery (5)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | **Incomplete (0)**                                                                                                                                                                                                                                                                                                                        |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| #### **Question 2a: Plot**                                | Students plot the series, ensuring high-quality visualization with clear labels and titles.                                                                                                                                                                                                                                                                                                                                                                                                                       | Submissions have low-quality visualizations or unclear labeling.                                                                                                                                                                                                                                                                          |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                           | **Mastery (10)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | **Incomplete (0)**                                                                                                                                                                                                                                                                                                                        |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| #### **Question 2b: Model Speculation**                   | Students provide a well-reasoned speculation on the likely model fit based on the plot, specifying model features for the trend, seasonality, and random component modeling choices. They articulate their reasoning clearly and logically, demonstrating an understanding of time series modeling principles.                                                                                                                                                                                                    | Submissions lack one or more modeling components, or provide a vague or superficial reasoning. The discussion doesn't provide enough evidence of understanding. The mathematical expressions are not in LaTex format and are hard to read                                                                                                 |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                           | **Mastery (20)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | **Incomplete (0)**                                                                                                                                                                                                                                                                                                                        |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| #### **Question 2c: Model Candidate**                     | Students propose three alternative models that are plausible candidates for the data-generating process of the Department Stores time series. The estimates include a models for the trend, seasonality, and random component. If there is autocorrelated error terms, the students apply the appropriate algorithm to avoid bias. They estimate each model and construct a clear and organized table comparing the models based on the AIC, AICc, and BIC criteria. The code is well-commented and easy to read. | There is one or more models missing. The estimation procedures has autocorrelation bias. There is one or more model components missing (trend, seasonality, random component). The table and results are not easy to read. One or mode models are not plausible candidates for the data generating process. The code is not easy to read. |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                           | **Mastery (20)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | **Incomplete (0)**                                                                                                                                                                                                                                                                                                                        |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| #### **Question 2d: Model Selection and Justification**   | The model justification uses statistical tests, practical significance and interpretability considerations, and model selection criteria to show what variables to include and which not to include. Students demonstrate a comprehensive understanding of the strengths and weaknesses of different model selection approaches and effectively integrate this knowledge into their justification.                                                                                                                | Students struggle to provide a clear and well-supported justification for their preferred model. They may overlook one or more of the criteria enumerated in the mastery section of this rubric item. Their justification doesn't provide enough evidence of mastery of model selection principles.\                                      |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                           | **Mastery (5)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | **Incomplete (0)**                                                                                                                                                                                                                                                                                                                        |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| #### **Question 3a: Plot**                                | Students plot the series, ensuring high-quality visualization with clear labels and titles.                                                                                                                                                                                                                                                                                                                                                                                                                       | Submissions have low-quality visualizations or unclear labeling.                                                                                                                                                                                                                                                                          |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                           | **Mastery (20)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | **Incomplete (0)**                                                                                                                                                                                                                                                                                                                        |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| #### **Question 3b: Non-Linear Exponential Model**        | Students estimate an exponential non-linear model. They present the results in professionally formatted tables, including all relevant parameters and statistics. The estimates include a model for the trend, seasonality, and random component. If there is autocorrelated error terms, the students apply the appropriate algorithm to avoid bias.                                                                                                                                                             | The estimation procedures has autocorrelation bias. There is one or more model components missing (trend, seasonality, random component). The table and results are not easy to read. The code is not easy to read.                                                                                                                       |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                           | **Mastery (10)**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | **Incomplete (0)**                                                                                                                                                                                                                                                                                                                        |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| #### **Question 3d: Interpretation Non-Linear Estimates** | Students provide correct and understandable interpretations of the coefficient estimates for the logarithmic transformation model, catering to the level of their audience. They effectively communicate the implications of each coefficient in straightforward language, making the interpretation accessible to someone with limited statistical expertise.                                                                                                                                                    | Interpretations of the coefficient estimates are incorrect or unclear, making it difficult for a non-expert audience to understand the implications of the results. Students may use overly technical or jargon-filled language, failing to effectively communicate the interpretation to the intended audience.\                         |
|                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | \                                                                                                                                                                                                                                                                                                                                         |
|                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | \                                                                                                                                                                                                                                                                                                                                         |
|                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | \                                                                                                                                                                                                                                                                                                                                         |
|                                                           |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | \                                                                                                                                                                                                                                                                                                                                         |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Total Points**                                          | **100**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                                                                                                                                                                                                                                                                                                                                           |
+-----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
